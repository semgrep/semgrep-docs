name: Meilisearch scrape

on:
  workflow_dispatch:
    inputs:
      parameter:
        description: Run from dispatch
  push:
    branches:
      - main
      - meilisearch-testing-clean

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: sleep 480s
        shell: bash
      
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Create scraper config
        run: |
          cat > meilisearch-config.json << 'EOF'
          {
            "index_uid": "semgrep_docs",
            "sitemap_urls": ["https://semgrep.dev/docs/sitemap.xml"],
            "start_urls": [
              {
                "url": "https://semgrep.dev/docs/release-notes",
                "tags": ["release_notes"]
              },
              {
                "url": "https://semgrep.dev/docs/rule-updates",
                "tags": ["rule_updates"]
              },
              {
                "url": "https://semgrep.dev/docs"
              }
            ],
            "stop_urls": [
              "https://semgrep.dev/docs/tags/*",
              "https://semgrep.dev/docs/category/*"
            ],
            "selectors": {
              "lvl0": {
                "selector": ".breadcrumbs > li:nth-child(2) span.breadcrumbs__link",
                "global": true,
                "default_value": "Semgrep documentation"
              },
              "lvl1": "article h1",
              "lvl2": "article h2",
              "lvl3": "article h3",
              "lvl4": "article h4",
              "lvl5": "article h5, article td:first-child",
              "lvl6": "article h6",
              "text": "article p, article li, article td:last-child, article code, article div table td, article div table th"
            },
            "strip_chars": " .,;:#()"
          }
          EOF
      
      - name: Run scraper
        env:
          MEILISEARCH_HOST_URL: ${{ secrets.MEILISEARCH_HOST_URL }}
          MEILISEARCH_API_KEY: ${{ secrets.MEILISEARCH_API_KEY }}
        run: |
          docker run -t --rm \
            -e MEILISEARCH_HOST_URL \
            -e MEILISEARCH_API_KEY \
            -v $PWD/meilisearch-config.json:/docs-scraper/config.json \
            getmeili/docs-scraper:latest pipenv run ./docs_scraper config.json
      
      - name: Restore index settings
        env:
          MEILISEARCH_HOST_URL: ${{ secrets.MEILISEARCH_HOST_URL }}
          MEILISEARCH_API_KEY: ${{ secrets.MEILISEARCH_API_KEY }}
        run: |
          echo "Restoring index settings to preserve synonyms and embedder..."
          curl -X PATCH \
            "${MEILISEARCH_HOST_URL}/indexes/semgrep_docs/settings" \
            -H "Authorization: Bearer ${MEILISEARCH_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-binary @- << 'SETTINGS_EOF'
          {
            "synonyms": {
              "autofix": ["autofix", "automatic fixes", "remediation", "code fixes"],
              "ci": ["ci", "continuous integration", "pipeline", "github actions", "gitlab ci", "automation"],
              "semgrep": ["semgrep", "static analysis", "security scanning", "code analysis", "sast tool"],
              "sso": ["sso", "single sign-on", "single sign on", "authentication"],
              "taint": ["taint", "taint analysis", "data flow", "taint mode", "taint tracking"],
              "findings": ["findings", "issues", "vulnerabilities", "results", "matches", "detections"],
              "secrets": ["secrets", "api keys", "tokens", "credentials", "sensitive data"],
              "sast": ["sast", "static application security testing", "code security", "security analysis"],
              "sca": ["sca", "supply chain", "dependencies", "vulnerabilities", "dependency scanning"]
            },
            "embedders": {
              "default": {
                "source": "openAi",
                "model": "text-embedding-3-small",
                "apiKey": "${{ secrets.OPENAI_API_KEY }}",
                "dimensions": 1536,
                "documentTemplate": "{% for field in fields %}{% if field.is_searchable and field.value != nil %}{{ field.name }}: {{ field.value }}\n{% endif %}{% endfor %}"
              }
            }
          }
          SETTINGS_EOF
          echo "Settings restored successfully"

